<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Predator - Exoplanet Detection</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Courier New', monospace;
      background: linear-gradient(135deg, #0a0e27 0%, #1a1a2e 50%, #16213e 100%);
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }

    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 40px;
      background: rgba(17, 17, 17, 0.95);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
    }

    .menu-toggle {
      font-size: 28px;
      cursor: pointer;
      color: #49DEB1;
      transition: transform 0.3s;
    }

    .menu-toggle:hover {
      transform: scale(1.1);
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
      color: #49DEB1;
      text-shadow: 2px 2px #12634B;
    }

    .sidebar {
      position: fixed;
      left: -300px;
      top: 0;
      width: 280px;
      height: 100vh;
      background: rgba(17, 17, 17, 0.98);
      backdrop-filter: blur(10px);
      z-index: 2000;
      transition: left 0.3s ease;
      border-right: 2px solid #49DEB1;
      overflow-y: auto;
    }

    .sidebar.open {
      left: 0;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 2px solid #49DEB1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .close-btn {
      font-size: 28px;
      cursor: pointer;
      color: #49DEB1;
    }

    .sidebar-menu {
      padding: 20px 0;
    }

    .menu-item {
      padding: 15px 30px;
      cursor: pointer;
      transition: all 0.3s;
      border-left: 3px solid transparent;
      color: #fff;
    }

    .menu-item:hover {
      background: rgba(73, 222, 177, 0.1);
      border-left-color: #49DEB1;
    }

    .page {
      display: none;
      padding: 40px 20px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .page.active {
      display: block;
    }

    .hero {
      text-align: center;
      margin-bottom: 50px;
      padding: 60px 20px;
      background: rgba(73, 222, 177, 0.1);
      border-radius: 20px;
      border: 2px solid rgba(73, 222, 177, 0.3);
    }

    .hero h1 {
      font-size: 56px;
      color: #49DEB1;
      text-shadow: 3px 3px #12634B;
      margin-bottom: 20px;
    }

    .upload-section {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 20px;
      padding: 40px;
      margin-bottom: 30px;
      border: 2px solid rgba(73, 222, 177, 0.2);
    }

    .upload-box {
      border: 3px dashed #49DEB1;
      border-radius: 15px;
      padding: 60px 20px;
      text-align: center;
      background: rgba(73, 222, 177, 0.05);
      cursor: pointer;
      transition: all 0.3s;
      display: block;
    }

    .upload-box:hover {
      background: rgba(73, 222, 177, 0.1);
    }

    .upload-box.drag-over {
      background: rgba(73, 222, 177, 0.2);
      border-color: #49DEB1;
      transform: scale(1.02);
    }

    .upload-box input {
      display: none;
    }

    .upload-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .btn {
      background: linear-gradient(135deg, #49DEB1 0%, #12634B 100%);
      color: white;
      padding: 15px 40px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 20px;
      font-family: 'Courier New', monospace;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(73, 222, 177, 0.4);
    }

    .btn:disabled {
      background: #555;
      cursor: not-allowed;
      opacity: 0.5;
    }

    .walkie-notification {
      position: fixed;
      right: -250px;
      top: 50%;
      transform: translateY(-50%);
      z-index: 1500;
      transition: right 0.5s ease;
    }

    .walkie-notification.show {
      right: 30px;
      animation: shake 0.5s infinite;
    }

    @keyframes shake {
      0%, 100% { transform: translateY(-50%) rotate(0deg); }
      25% { transform: translateY(-50%) rotate(-5deg); }
      75% { transform: translateY(-50%) rotate(5deg); }
    }

    .walkie-container {
      background: rgba(0, 0, 0, 0.9);
      border: 3px solid #0f0;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 0 30px rgba(0, 255, 0, 0.5);
    }

    .walkie-icon {
      font-size: 80px;
      margin-bottom: 10px;
      filter: drop-shadow(0 0 10px #0f0);
    }

    .walkie-text {
      color: #0f0;
      font-weight: bold;
      font-size: 14px;
      text-shadow: 0 0 5px #0f0;
    }

    #results {
      background: #000;
      min-height: calc(100vh - 70px);
      position: relative;
    }

    .noise-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(
        0deg,
        rgba(0, 255, 0, 0.03) 0px,
        transparent 1px,
        transparent 2px,
        rgba(0, 255, 0, 0.03) 3px
      );
      pointer-events: none;
      animation: scan-lines 8s linear infinite;
    }

    @keyframes scan-lines {
      0% { transform: translateY(0); }
      100% { transform: translateY(10px); }
    }

    .codec-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 20px;
      position: relative;
      z-index: 1;
    }

    .codec-header {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
    }

    .info-box {
      border: 3px solid #0f0;
      background: rgba(0, 20, 0, 0.95);
      padding: 20px;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
      text-align: center;
      position: relative;
    }

    .info-box::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        180deg,
        transparent,
        transparent 2px,
        rgba(0, 255, 0, 0.05) 2px,
        rgba(0, 255, 0, 0.05) 4px
      );
      pointer-events: none;
    }

    .info-label {
      font-size: 12px;
      color: #0a0;
      margin-bottom: 5px;
      position: relative;
      z-index: 1;
    }

    .info-value {
      font-size: 24px;
      font-weight: bold;
      color: #0f0;
      text-shadow: 0 0 10px #0f0;
      position: relative;
      z-index: 1;
    }

    .avatar-box {
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 64px;
    }

    .codec-content {
      border: 3px solid #0f0;
      background: rgba(0, 20, 0, 0.95);
      padding: 30px;
      min-height: 400px;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.5);
      position: relative;
    }

    .codec-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: repeating-linear-gradient(
        180deg,
        transparent,
        transparent 2px,
        rgba(0, 255, 0, 0.05) 2px,
        rgba(0, 255, 0, 0.05) 4px
      );
      pointer-events: none;
    }

    .speaker-name {
      font-weight: bold;
      font-size: 18px;
      color: #0f0;
      margin-bottom: 15px;
      text-shadow: 0 0 10px #0f0;
      position: relative;
      z-index: 1;
    }

    .dialogue-text {
      font-size: 20px;
      line-height: 1.8;
      color: #0f0;
      min-height: 100px;
      white-space: pre-wrap;
      position: relative;
      z-index: 1;
    }

    .results-list {
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      position: relative;
      z-index: 1;
    }

    .result-row {
      background: rgba(0, 40, 0, 0.3);
      border: 1px solid #0a0;
      padding: 15px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 15px;
    }

    .result-classification {
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .classification-confirmed {
      color: #0f0;
      text-shadow: 0 0 8px #0f0;
    }

    .classification-candidate {
      color: #ff0;
      text-shadow: 0 0 8px #ff0;
    }

    .classification-false {
      color: #f00;
      text-shadow: 0 0 8px #f00;
    }

    .skip-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 255, 0, 0.2);
      border: 2px solid #0f0;
      color: #0f0;
      padding: 10px 20px;
      cursor: pointer;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      font-size: 14px;
      z-index: 10;
      transition: all 0.3s;
    }

    .skip-btn:hover {
      background: rgba(0, 255, 0, 0.4);
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #0a0;
    }

    .glitch {
      animation: glitch 3s infinite;
    }

    @keyframes glitch {
      0%, 90%, 100% { transform: translate(0); }
      91% { transform: translate(-2px, 1px); }
      92% { transform: translate(2px, -1px); }
      93% { transform: translate(-1px, 2px); }
    }

    .hidden {
      display: none;
    }

    .chart-container {
      margin-bottom: 30px;
      background: rgba(0, 40, 0, 0.3);
      border: 2px solid #0a0;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    .chart-title {
      color: #0f0;
      font-weight: bold;
      margin-bottom: 15px;
      text-shadow: 0 0 10px #0f0;
      font-size: 16px;
    }
  </style>
</head>
<body>

  <nav>
    <div class="menu-toggle" onclick="toggleSidebar()">☰</div>
    <div class="logo">THE PREDATOR</div>
    <div style="width: 40px;"></div>
  </nav>

  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div style="color: #49DEB1; font-weight: bold;">MENU</div>
      <div class="close-btn" onclick="toggleSidebar()">×</div>
    </div>
    <div class="sidebar-menu">
      <div class="menu-item" onclick="showPage('home')">🏠 Home</div>
      <div class="menu-item" onclick="showPage('results')">📊 Results</div>
    </div>
  </div>

  <div class="page active" id="home">
    <div class="hero">
      <h1>🌌 Exoplanet Detection System</h1>
    </div>

    <div class="upload-section">
      <h2 style="color: #49DEB1; margin-bottom: 20px;">📤 Upload NPZ File</h2>
      <label for="fileInput" class="upload-box" id="uploadBox">
        <div class="upload-icon">📁</div>
        <p style="color: #ccc; font-size: 18px;">Click or drag NPZ file here</p>
        <p id="fileName" style="margin-top: 15px; color: #49DEB1; font-weight: bold;"></p>
        <input type="file" id="fileInput" accept=".npz">
      </label>
      
      <button class="btn" id="analyzeBtn" onclick="analyzeData()" disabled>
        Analyze with AI Model
      </button>
    </div>
  </div>

  <div class="page" id="results">
    <div class="noise-overlay"></div>
    <div class="codec-container">
      <div class="codec-header">
        <div class="info-box">
          <div class="info-label">OPERATOR</div>
          <div class="info-value glitch">USER</div>
        </div>
        <div class="info-box">
          <div class="info-label">CONTACT</div>
          <div class="info-value glitch">THE PREDATOR</div>
        </div>
        <div class="info-box avatar-box">
          👽
        </div>
      </div>

      <div class="codec-content">
        <div id="resultsEmpty" class="empty-state">
          <div class="speaker-name">THE PREDATOR:</div>
          <div class="dialogue-text">No mission data received yet.<br><br>Upload and analyze NPZ file from the Home page to begin transmission...</div>
        </div>

        <div id="resultsLoaded" class="hidden">
          <button class="skip-btn" id="skipBtn" onclick="skipDialogue()">SKIP →</button>
          <div class="speaker-name glitch">THE PREDATOR:</div>
          <div class="dialogue-text" id="codecDialogue">Initializing...</div>
          
          <div id="codecStats" class="hidden">
            <div class="chart-container">
              <div class="chart-title">LIGHT CURVE ANALYSIS:</div>
              <canvas id="lightCurveChart"></canvas>
            </div>
            <div class="results-list" id="codecResults"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="walkie-notification" id="walkieNotification">
    <div class="walkie-container" onclick="goToResults()">
      <div class="walkie-icon">📻</div>
      <div class="walkie-text">CLICK TO SEE<br>RESULTS</div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <script>
    let analysisResults = null;
    let lightCurveData = null;
    let currentDialogueLine = 0;

    const dialogue = [
      "Kept you waiting, huh?",
      "This is Predator. Target acquired and analyzed...",
      "Light curve processed. Classification complete...",
      "Displaying results now..."
    ];

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    function showPage(pageName) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageName).classList.add('active');
      document.getElementById('sidebar').classList.remove('open');
      
      if (pageName === 'home') {
        document.getElementById('fileName').textContent = '';
        document.getElementById('analyzeBtn').disabled = true;
        document.getElementById('analyzeBtn').textContent = 'Analyze with AI Model';
        document.getElementById('fileInput').value = '';
      }
      
      if (pageName === 'results' && analysisResults && analysisResults.length > 0) {
        // Show results immediately without dialogue when manually navigating
        showResultsDirectly();
      }
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        document.getElementById('fileName').textContent = '✓ ' + file.name;
        document.getElementById('analyzeBtn').disabled = false;
      }
    });

    // Drag and drop functionality
    const uploadBox = document.getElementById('uploadBox');
    const fileInput = document.getElementById('fileInput');

    uploadBox.addEventListener('dragover', function(e) {
      e.preventDefault();
      e.stopPropagation();
      uploadBox.classList.add('drag-over');
    });

    uploadBox.addEventListener('dragleave', function(e) {
      e.preventDefault();
      e.stopPropagation();
      uploadBox.classList.remove('drag-over');
    });

    uploadBox.addEventListener('drop', function(e) {
      e.preventDefault();
      e.stopPropagation();
      uploadBox.classList.remove('drag-over');
      
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const file = files[0];
        if (file.name.endsWith('.npz')) {
          fileInput.files = files;
          document.getElementById('fileName').textContent = '✓ ' + file.name;
          document.getElementById('analyzeBtn').disabled = false;
        } else {
          alert('Please upload a .npz file');
        }
      }
    });

    async function analyzeData() {
      const fileInput = document.getElementById('fileInput');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        alert('Please upload an NPZ file first');
        return;
      }

      const btn = document.getElementById('analyzeBtn');
      btn.disabled = true;
      btn.textContent = 'Analyzing...';

      // Clear ALL previous results when starting new analysis
      analysisResults = null;
      lightCurveData = null;
      currentDialogueLine = 0;
      
      // Reset results display completely
      const resultsEmpty = document.getElementById('resultsEmpty');
      const resultsLoaded = document.getElementById('resultsLoaded');
      const codecResults = document.getElementById('codecResults');
      const codecStats = document.getElementById('codecStats');
      
      if (resultsEmpty) resultsEmpty.classList.remove('hidden');
      if (resultsLoaded) resultsLoaded.classList.add('hidden');
      if (codecResults) codecResults.innerHTML = '';
      if (codecStats) codecStats.classList.add('hidden');
      
      // Destroy previous chart if exists
      if (window.lightCurveChartInstance) {
        window.lightCurveChartInstance.destroy();
        window.lightCurveChartInstance = null;
      }

      try {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        
        console.log('Sending file to backend...');
        
        const response = await fetch('http://localhost:5000/predict', {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`Server error: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('Backend response:', result);
        
        analysisResults = result.results || [];
        lightCurveData = result.light_curve || null;

        document.getElementById('walkieNotification').classList.add('show');
        btn.textContent = 'Analysis Complete!';
        btn.disabled = false;

      } catch (error) {
        console.error('Analysis error:', error);
        alert('Error during analysis: ' + error.message + '\n\nMake sure your Flask backend is running on http://localhost:5000');
        btn.disabled = false;
        btn.textContent = 'Analyze with AI Model';
      }
    }

    function goToResults() {
      // This function is called FROM walkie notification (new analysis)
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('results').classList.add('active');
      document.getElementById('walkieNotification').classList.remove('show');
      
      // Clear everything first
      const codecResults = document.getElementById('codecResults');
      const codecStats = document.getElementById('codecStats');
      if (codecResults) codecResults.innerHTML = '';
      if (codecStats) codecStats.classList.add('hidden');
      
      const resultsEmpty = document.getElementById('resultsEmpty');
      const resultsLoaded = document.getElementById('resultsLoaded');
      const skipBtn = document.getElementById('skipBtn');
      
      if (resultsEmpty) resultsEmpty.classList.add('hidden');
      if (resultsLoaded) resultsLoaded.classList.remove('hidden');
      if (skipBtn) skipBtn.style.display = 'block';
      
      currentDialogueLine = 0;
      typeDialogue();
    }

    function showResultsDirectly() {
      // This function is called when manually navigating to results (no dialogue)
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('results').classList.add('active');
      
      // Don't clear - keep existing results
      const resultsEmpty = document.getElementById('resultsEmpty');
      const resultsLoaded = document.getElementById('resultsLoaded');
      const skipBtn = document.getElementById('skipBtn');
      
      if (resultsEmpty) resultsEmpty.classList.add('hidden');
      if (resultsLoaded) resultsLoaded.classList.remove('hidden');
      if (skipBtn) skipBtn.style.display = 'none';
      
      // Show final dialogue text without typing
      document.getElementById('codecDialogue').textContent = dialogue[dialogue.length - 1];
      
      // Display results immediately (only if not already shown)
      if (analysisResults && analysisResults.length > 0) {
        const codecResults = document.getElementById('codecResults');
        if (!codecResults.innerHTML) {
          displayResults();
        }
      }
    }

    function skipDialogue() {
      currentDialogueLine = dialogue.length;
      document.getElementById('codecDialogue').textContent = dialogue[dialogue.length - 1];
      const skipBtn = document.getElementById('skipBtn');
      if (skipBtn) skipBtn.style.display = 'none';
      displayResults();
    }

    function typeDialogue() {
      if (currentDialogueLine >= dialogue.length) {
        const skipBtn = document.getElementById('skipBtn');
        if (skipBtn) skipBtn.style.display = 'none';
        setTimeout(displayResults, 500);
        return;
      }

      const text = dialogue[currentDialogueLine];
      const element = document.getElementById('codecDialogue');
      let i = 0;
      element.textContent = '';

      const interval = setInterval(() => {
        if (i < text.length) {
          element.textContent += text[i];
          i++;
        } else {
          clearInterval(interval);
          currentDialogueLine++;
          setTimeout(typeDialogue, 800);
        }
      }, 40);
    }

    function displayResults() {
      if (!analysisResults || analysisResults.length === 0) return;

      // Clear previous chart first
      if (window.lightCurveChartInstance) {
        window.lightCurveChartInstance.destroy();
        window.lightCurveChartInstance = null;
      }

      // Display light curve chart
      if (lightCurveData && lightCurveData.time && lightCurveData.flux) {
        const ctx = document.getElementById('lightCurveChart').getContext('2d');
        
        window.lightCurveChartInstance = new Chart(ctx, {
          type: 'line',
          data: {
            labels: lightCurveData.time,
            datasets: [{
              label: 'Normalized Flux',
              data: lightCurveData.flux,
              borderColor: '#0f0',
              backgroundColor: 'rgba(0, 255, 0, 0.1)',
              borderWidth: 2,
              pointRadius: 0,
              pointHitRadius: 5
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.5,
            plugins: {
              legend: {
                labels: {
                  color: '#0f0',
                  font: {
                    family: "'Courier New', monospace",
                    size: 14
                  }
                }
              },
              title: {
                display: false
              }
            },
            scales: {
              x: {
                title: {
                  display: true,
                  text: 'Time (days)',
                  color: '#0f0',
                  font: {
                    family: "'Courier New', monospace",
                    size: 12
                  }
                },
                ticks: {
                  color: '#0a0',
                  font: {
                    family: "'Courier New', monospace"
                  },
                  maxTicksLimit: 10
                },
                grid: {
                  color: 'rgba(0, 255, 0, 0.1)'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Normalized Flux',
                  color: '#0f0',
                  font: {
                    family: "'Courier New', monospace",
                    size: 12
                  }
                },
                ticks: {
                  color: '#0a0',
                  font: {
                    family: "'Courier New', monospace"
                  }
                },
                grid: {
                  color: 'rgba(0, 255, 0, 0.1)'
                }
              }
            }
          }
        });
      }

      let resultsHTML = '';
      
      for (let i = 0; i < analysisResults.length; i++) {
        const r = analysisResults[i];
        let classColor = '';
        let classText = '';
        
        if (r.classification === 'Confirmed Exoplanet') {
          classColor = 'classification-confirmed';
          classText = '✓ CONFIRMED EXOPLANET';
        } else if (r.classification === 'Candidate') {
          classColor = 'classification-candidate';
          classText = '? CANDIDATE';
        } else {
          classColor = 'classification-false';
          classText = '✗ FALSE POSITIVE';
        }
        
        resultsHTML += `
          <div class="result-row">
            <div>
              <span style="color: #0a0;">[${r.kepoi_name || 'TARGET #' + r.id}]</span>
              <span class="result-classification ${classColor}"> ${classText}</span>
            </div>
            <span style="color: #0f0;">CONFIDENCE: ${r.confidence}%</span>
          </div>
        `;
      }

      document.getElementById('codecResults').innerHTML = resultsHTML;
      document.getElementById('codecStats').classList.remove('hidden');
    }
  </script>

</body>
</html>